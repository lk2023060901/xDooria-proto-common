syntax = "proto3";

package common;

option go_package = "github.com/xDooria/xDooria-proto-common;common";

// =============================================================================
// 框架保留错误码：0-10000
// 业务侧自定义：10001+ (由业务开发者自行规划使用)
// =============================================================================

// ErrCode 框架保留错误码
enum ErrCode {
  // 成功
  ERR_CODE_OK = 0;

  // ---------------------------------------------------------------------
  // 通用错误：1000-1999
  // ---------------------------------------------------------------------
  ERR_CODE_UNKNOWN = 1000;            // 未知错误
  ERR_CODE_INVALID_ARGUMENT = 1001;   // 无效参数
  ERR_CODE_NOT_FOUND = 1002;          // 资源不存在
  ERR_CODE_ALREADY_EXISTS = 1003;     // 资源已存在
  ERR_CODE_PERMISSION_DENIED = 1004;  // 权限不足
  ERR_CODE_UNAUTHENTICATED = 1005;    // 未认证
  ERR_CODE_RESOURCE_EXHAUSTED = 1006; // 资源耗尽
  ERR_CODE_INTERNAL = 1007;           // 内部错误
  ERR_CODE_UNAVAILABLE = 1008;        // 服务不可用
  ERR_CODE_DEADLINE_EXCEEDED = 1009;  // 超时
  ERR_CODE_CANCELLED = 1010;          // 已取消
  ERR_CODE_DATA_LOSS = 1011;          // 数据丢失
  ERR_CODE_ABORTED = 1012;            // 操作中止

  // ---------------------------------------------------------------------
  // 数据库错误：2000-2999
  // ---------------------------------------------------------------------
  ERR_CODE_DB_CONNECTION = 2001;      // 数据库连接失败
  ERR_CODE_DB_QUERY = 2002;           // 查询失败
  ERR_CODE_DB_TRANSACTION = 2003;     // 事务失败
  ERR_CODE_DB_DUPLICATE = 2004;       // 重复记录
  ERR_CODE_DB_CONSTRAINT = 2005;      // 约束违反
  ERR_CODE_DB_TIMEOUT = 2006;         // 数据库超时

  // ---------------------------------------------------------------------
  // 缓存错误：3000-3999
  // ---------------------------------------------------------------------
  ERR_CODE_CACHE_CONNECTION = 3001;   // 缓存连接失败
  ERR_CODE_CACHE_MISS = 3002;         // 缓存未命中
  ERR_CODE_CACHE_EXPIRED = 3003;      // 缓存已过期
  ERR_CODE_CACHE_SERIALIZATION = 3004;// 缓存序列化失败

  // ---------------------------------------------------------------------
  // 外部服务错误：4000-4999
  // ---------------------------------------------------------------------
  ERR_CODE_EXTERNAL_SERVICE = 4001;   // 外部服务错误
  ERR_CODE_EXTERNAL_TIMEOUT = 4002;   // 外部服务超时
  ERR_CODE_EXTERNAL_UNAVAILABLE = 4003; // 外部服务不可用

  // ---------------------------------------------------------------------
  // 认证授权错误：5000-5999
  // ---------------------------------------------------------------------
  ERR_CODE_TOKEN_EXPIRED = 5001;      // Token 过期
  ERR_CODE_TOKEN_INVALID = 5002;      // Token 无效
  ERR_CODE_TOKEN_MISSING = 5003;      // Token 缺失
  ERR_CODE_SESSION_EXPIRED = 5004;    // 会话过期
  ERR_CODE_ACCESS_DENIED = 5005;      // 访问拒绝
  ERR_CODE_SIGNATURE_INVALID = 5006;  // 签名无效

  // ---------------------------------------------------------------------
  // 限流熔断错误：6000-6999
  // ---------------------------------------------------------------------
  ERR_CODE_RATE_LIMITED = 6001;       // 请求被限流
  ERR_CODE_CIRCUIT_OPEN = 6002;       // 熔断器打开
  ERR_CODE_QUOTA_EXCEEDED = 6003;     // 配额超限

  // ---------------------------------------------------------------------
  // 消息队列错误：7000-7999
  // ---------------------------------------------------------------------
  ERR_CODE_MQ_CONNECTION = 7001;      // 消息队列连接失败
  ERR_CODE_MQ_PUBLISH = 7002;         // 消息发布失败
  ERR_CODE_MQ_CONSUME = 7003;         // 消息消费失败

  // ---------------------------------------------------------------------
  // 配置错误：8000-8999
  // ---------------------------------------------------------------------
  ERR_CODE_CONFIG_INVALID = 8001;     // 配置无效
  ERR_CODE_CONFIG_MISSING = 8002;     // 配置缺失
  ERR_CODE_CONFIG_LOAD_FAILED = 8003; // 配置加载失败
}

// ErrorInfo 业务错误详情
// 用于 gRPC status.Status 的 details 字段
//
// 错误码规范：
//   - 框架保留：0-10000
//   - 业务侧自定义：10001+ (由业务开发者自行规划使用)
message ErrorInfo {
  // 错误码（整型，支持业务扩展）
  int32 err_code = 1;

  // 错误域（模块标识）
  // 如："user", "order", "payment", "auth"
  string domain = 2;

  // 错误原因（机器可读的错误标识）
  // 如："USER_NOT_FOUND", "INVALID_PASSWORD", "ORDER_EXPIRED"
  string reason = 3;

  // 错误消息（人类可读的描述）
  string message = 4;

  // 元数据（附加信息）
  // 如：{"user_id": "123", "field": "email"}
  map<string, string> metadata = 5;
}

// FieldViolation 字段校验错误
message FieldViolation {
  // 字段路径
  // 如："user.email", "items[0].quantity"
  string field = 1;

  // 错误描述
  string description = 2;
}

// ValidationError 参数校验错误详情
// 用于批量返回多个字段的校验错误
message ValidationError {
  // 校验失败的字段列表
  repeated FieldViolation violations = 1;
}

// RetryInfo 重试信息
// 告知客户端何时可以重试
message RetryInfo {
  // 建议重试延迟（秒）
  int32 retry_delay_seconds = 1;
}

// DebugInfo 调试信息
// 仅在开发/测试环境返回，生产环境应过滤
message DebugInfo {
  // 错误堆栈
  repeated string stack_entries = 1;

  // 详细描述
  string detail = 2;
}
